name: frontend-deploy

on:
  push:
    branches: [ main ]
    paths:
      - "**/*.html"
      - "**/*.css"
      - "**/*.js"
      - "**/*.png"
      - "**/*.jpg"
      - "**/*.jpeg"
      - "**/*.svg"
      - "**/*.ico"
      - "**/*.webmanifest"
      - ".github/workflows/frontend.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  STORAGE_ACCOUNT: saswewtsz1

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: frontend-deploy
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Upload files to Azure Storage
        uses: azure/CLI@v2
        with:
          azcliversion: latest
          inlineScript: |
            set -euo pipefail
            ACCOUNT="${{ env.STORAGE_ACCOUNT }}"
            
            # Get the subscription ID for explicit resource targeting
            SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            
            # Clear existing files first
            echo "Clearing existing files..."
            az storage blob delete-batch \
              --account-name "$ACCOUNT" \
              --source '$web' \
              --subscription "$SUBSCRIPTION_ID" || true
            
            # Upload all files
            echo "Uploading files..."
            for file in $(find . -type f \
              ! -path "./.git/*" \
              ! -path "./.github/*" \
              ! -name "*.md" \
              ! -name "*.MD" \
              ! -name "*.yml" \
              ! -name "*.yaml"); do
              
              # Remove leading ./
              blob_name=${file#./}
              echo "Uploading: $blob_name"
              
              az storage blob upload \
                --account-name "$ACCOUNT" \
                --container-name '$web' \
                --name "$blob_name" \
                --file "$file" \
                --subscription "$SUBSCRIPTION_ID" \
                --overwrite
            done
            
            echo "Website URL:"
            az storage account show -n "$ACCOUNT" --subscription "$SUBSCRIPTION_ID" --query "primaryEndpoints.web" -o tsv
